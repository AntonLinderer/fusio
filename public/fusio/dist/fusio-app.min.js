/*
 fusio
 Copyright (C) 2015-2016 Christoph Kappestein
 License: AGPLv3
*/
"use strict";var fusioApp=angular.module("fusioApp",["ngRoute","ngSanitize","ngAnimate","ui.bootstrap","ui.ace","chart.js","ng-showdown","hljs","angular-loading-bar","fusioApp.account","fusioApp.action","fusioApp.app","fusioApp.config","fusioApp.connection","fusioApp.dashboard","fusioApp.import","fusioApp.log","fusioApp.login","fusioApp.logout","fusioApp.rate","fusioApp.routes","fusioApp.schema","fusioApp.scope","fusioApp.statistic","fusioApp.user"]);fusioApp.value("version","v0.3"),fusioApp.provider("fusio",function(){var baseUrl=null;this.setBaseUrl=function(_baseUrl){baseUrl=_baseUrl},this.guessFusioEndpointUrl=function(urlRewrite){var url=window.location.href,pos=url.lastIndexOf("/fusio");return pos!==-1&&(url=url.substring(0,pos)),url+(urlRewrite?"/":"/index.php/")},this.$get=function(){return null===baseUrl&&"undefined"!=typeof fusio_url?baseUrl=fusio_url:null===baseUrl&&(baseUrl=this.guessFusioEndpointUrl(!1)),{baseUrl:baseUrl}}}),fusioApp.factory("fusioIsAuthenticated",["$location","$window","$q",function($location,$window,$q){return{responseError:function(response){return 400==response.status&&response.data.message&&response.data.message.indexOf("Invalid access token")!==-1&&($window.sessionStorage.removeItem("fusio_access_token"),$location.path("/login")),$q.reject(response)}}}]),fusioApp.config(["$routeProvider",function($routeProvider){$routeProvider.otherwise({redirectTo:"/dashboard"})}]),fusioApp.config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("fusioIsAuthenticated")}]),fusioApp.config(["$showdownProvider",function($showdownProvider){}]),fusioApp.config(["cfpLoadingBarProvider",function(cfpLoadingBarProvider){cfpLoadingBarProvider.includeBar=!1,cfpLoadingBarProvider.includeSpinner=!0,cfpLoadingBarProvider.parentSelector=".fusio-loading-container"}]),fusioApp.run(function($rootScope,$window,$location,$http,helpLoader,version){var token=$window.sessionStorage.getItem("fusio_access_token");token?($http.defaults.headers.common.Authorization="Bearer "+token,$rootScope.userAuthenticated=!0):$location.path("/login"),$rootScope.help=helpLoader,$rootScope.version=version}),angular.module("fusioApp.account",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/account/change_password",{templateUrl:"app/account/change_password.html",controller:"ChangePasswordCtrl"})}]).controller("ChangePasswordCtrl",["$scope","$http","fusio",function($scope,$http,fusio){$scope.account={oldPassword:"",newPassword:"",verifyPassword:""},$scope.updatePassword=function(){$http.put(fusio.baseUrl+"backend/account/change_password",$scope.account).success(function(data){$scope.response=data}).error(function(data){$scope.response=data})},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.login",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/login",{templateUrl:"app/login/index.html",controller:"LoginCtrl"})}]).controller("LoginCtrl",["$scope","$http","$location","$window","$rootScope","fusio",function($scope,$http,$location,$window,$rootScope,fusio){$scope.credentials={username:"",password:""},$scope.response=null,$scope.loading=!1,$scope.login=function(credentials){$scope.loading=!0;var req={method:"POST",url:fusio.baseUrl+"backend/token",headers:{authorization:"Basic "+btoa(credentials.username+":"+credentials.password)},data:"grant_type=client_credentials"};$http(req).success(function(data){$scope.loading=!1,data.access_token?($http.defaults.headers.common.Authorization="Bearer "+data.access_token,$window.sessionStorage.setItem("fusio_access_token",data.access_token),$location.path("/dashboard"),$rootScope.userAuthenticated=!0):$scope.response=data.error_description?data.error_description:"Authentication failed"}).error(function(data){$scope.loading=!1,$scope.response=data.error_description?data.error_description:"Authentication failed"})}}]),angular.module("fusioApp.logout",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/logout",{templateUrl:"app/logout/index.html",controller:"LogoutCtrl"})}]).controller("LogoutCtrl",["$scope","$http","$location","$window","$rootScope","fusio",function($scope,$http,$location,$window,$rootScope,fusio){var removeToken=function(){delete $http.defaults.headers.common.Authorization,$window.sessionStorage.removeItem("fusio_access_token"),$rootScope.userAuthenticated=!1,$location.path("/login")};$http.post(fusio.baseUrl+"authorization/revoke",null).success(removeToken).error(removeToken)}]),angular.module("fusioApp.dashboard",["ngRoute","chart.js"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/dashboard",{templateUrl:"app/dashboard/index.html",controller:"DashboardCtrl"})}]).controller("DashboardCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){var fromDate=new Date;fromDate.setDate(fromDate.getDate()-9);var toDate=new Date,query="?from="+fromDate.toISOString()+"&to="+toDate.toISOString();$http.get(fusio.baseUrl+"backend/statistic/incoming_requests"+query).success(function(data){$scope.incomingRequests=data}),$http.get(fusio.baseUrl+"backend/statistic/most_used_routes"+query).success(function(data){$scope.mostUsedRoutes=data}),$http.get(fusio.baseUrl+"backend/statistic/most_used_apps"+query).success(function(data){$scope.mostUsedApps=data}),$http.get(fusio.baseUrl+"backend/dashboard/latest_requests").success(function(data){$scope.latestRequests=data.entry}),$http.get(fusio.baseUrl+"backend/dashboard/latest_apps").success(function(data){$scope.latestApps=data.entry}),$http.get(fusio.baseUrl+"backend/statistic/errors_per_route"+query).success(function(data){$scope.errorsPerRoute=data})}]),angular.module("fusioApp.routes",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/routes",{templateUrl:"app/routes/index.html",controller:"RoutesCtrl"})}]).controller("RoutesCtrl",["$scope","$http","$uibModal","$routeParams","fusio",function($scope,$http,$uibModal,$routeParams,fusio){$scope.response=null,$scope.search="",$scope.load=function(){var search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/routes?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.routes=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/routes?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.routes=data.entry})},$scope.doSearch=function(search){$http.get(fusio.baseUrl+"backend/routes?search="+encodeURIComponent(search)).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.routes=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/routes/create.html",controller:"RoutesCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(route){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/routes/update.html",controller:"RoutesUpdateCtrl",resolve:{route:function(){return route}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(route){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/routes/delete.html",controller:"RoutesDeleteCtrl",resolve:{route:function(){return route}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load()}]).controller("RoutesCreateCtrl",["$scope","$http","$uibModalInstance","fusio",function($scope,$http,$uibModalInstance,fusio){$scope.route={path:"",config:[]},$scope.methods=["GET","POST","PUT","DELETE"],$scope.schemas=[],$scope.actions=[],$scope.statuuus=[{key:4,value:"Development"},{key:1,value:"Production"},{key:2,value:"Deprecated"},{key:3,value:"Closed"}],$scope.create=function(route){var data=angular.copy(route);if(angular.isObject(data.config))for(var i=0;i<data.config.length;i++)data.config[i].hasOwnProperty("active")&&delete data.config[i].active;$http.post(fusio.baseUrl+"backend/routes",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$http.get(fusio.baseUrl+"backend/action").success(function(data){$scope.actions=data.entry}),$http.get(fusio.baseUrl+"backend/schema").success(function(data){$scope.schemas=data.entry}),$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.addVersion=function(){for(var versions=[],i=0;i<$scope.route.config.length;i++){var version=$scope.route.config[i];version.active=!1,versions.push(version)}versions.push($scope.newVersion()),$scope.route.config=versions},$scope.newVersion=function(){for(var version={version:$scope.getLatestVersion()+1,active:!0,status:4,methods:{}},i=0;i<$scope.methods.length;i++)version.methods[$scope.methods[i]]={};return version},$scope.getLatestVersion=function(){for(var version=0,i=0;i<$scope.route.config.length;i++){var ver=parseInt($scope.route.config[i].version);ver>version&&(version=ver)}return version},$scope.addVersion()}]).controller("RoutesUpdateCtrl",["$scope","$http","$uibModalInstance","fusio","route",function($scope,$http,$uibModalInstance,fusio,route){$scope.route=route,$scope.methods=["GET","POST","PUT","DELETE"],$scope.schemas=[],$scope.actions=[],$scope.statuuus=[{key:4,value:"Development"},{key:1,value:"Production"},{key:2,value:"Deprecated"},{key:3,value:"Closed"}],$scope.update=function(route){var data=angular.copy(route);if(angular.isObject(data.config))for(var i=0;i<data.config.length;i++)data.config[i].hasOwnProperty("active")&&delete data.config[i].active;$http.put(fusio.baseUrl+"backend/routes/"+route.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$http.get(fusio.baseUrl+"backend/routes/"+route.id).success(function(data){if(data.config){var config=[];for(var version in data.config){for(var ver=data.config[version],methods={},i=0;i<$scope.methods.length;i++)ver.methods.hasOwnProperty($scope.methods[i])?methods[$scope.methods[i]]=ver.methods[$scope.methods[i]]:methods[$scope.methods[i]]={};ver.methods=methods,config.push(ver)}data.config=config}$scope.route=data}),$http.get(fusio.baseUrl+"backend/action").success(function(data){$scope.actions=data.entry}),$http.get(fusio.baseUrl+"backend/schema").success(function(data){$scope.schemas=data.entry}),$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.addVersion=function(){for(var versions=[],i=0;i<$scope.route.config.length;i++){var version=$scope.route.config[i];version.active=!1,versions.push(version)}versions.push($scope.newVersion()),$scope.route.config=versions},$scope.newVersion=function(){for(var version={version:$scope.getLatestVersion()+1,active:!0,status:4,methods:{}},i=0;i<$scope.methods.length;i++)version.methods[$scope.methods[i]]={};return version},$scope.getLatestVersion=function(){for(var version=0,i=0;i<$scope.route.config.length;i++){var ver=parseInt($scope.route.config[i].version);ver>version&&(version=ver)}return version}}]).controller("RoutesDeleteCtrl",["$scope","$http","$uibModalInstance","fusio","route",function($scope,$http,$uibModalInstance,fusio,route){$scope.route=route,$scope["delete"]=function(route){$http["delete"](fusio.baseUrl+"backend/routes/"+route.id).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.schema",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/schema",{templateUrl:"app/schema/index.html",controller:"SchemaCtrl"})}]).controller("SchemaCtrl",["$scope","$http","$uibModal","$routeParams","$location","fusio",function($scope,$http,$uibModal,$routeParams,$location,fusio){$scope.response=null,$scope.search="",$scope.routes=[],$scope.routeId=$routeParams.routeId?parseInt($routeParams.routeId):null,$scope.load=function(){var search=encodeURIComponent($scope.search),routeId=$scope.routeId;$http.get(fusio.baseUrl+"backend/schema?search="+search+"&routeId="+routeId).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.schemas=data.entry})},$scope.loadRoutes=function(){$http.get(fusio.baseUrl+"backend/routes").success(function(data){$scope.routes=data.entry})},$scope.changeRoute=function(){$location.search("routeId",$scope.routeId)},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/schema?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.schemas=data.entry})},$scope.doSearch=function(search){var routeId=$scope.routeId;$http.get(fusio.baseUrl+"backend/schema?search="+encodeURIComponent(search)+"&routeId="+routeId).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.schemas=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/schema/create.html",controller:"SchemaCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(schema){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/schema/update.html",controller:"SchemaUpdateCtrl",resolve:{schema:function(){return schema}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(schema){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/schema/delete.html",controller:"SchemaDeleteCtrl",resolve:{schema:function(){return schema}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load(),$scope.loadRoutes()}]).controller("SchemaCreateCtrl",["$scope","$http","$uibModalInstance","fusio",function($scope,$http,$uibModalInstance,fusio){$scope.schema={name:"",source:""},$scope.create=function(schema){var data=angular.copy(schema);angular.isString(data.source)&&(data.source=JSON.parse(data.source)),$http.post(fusio.baseUrl+"backend/schema",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]).controller("SchemaUpdateCtrl",["$scope","$http","$uibModalInstance","$uibModal","fusio","schema",function($scope,$http,$uibModalInstance,$uibModal,fusio,schema){$scope.schema=schema,$scope.update=function(schema){var data=angular.copy(schema);angular.isString(data.source)&&(data.source=JSON.parse(data.source)),$http.put(fusio.baseUrl+"backend/schema/"+schema.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.preview=function(schema){var data=angular.copy(schema);"string"==typeof data.source&&(data.source=JSON.parse(data.source)),$http.put(fusio.baseUrl+"backend/schema/"+data.id,data).success(function(data){if($scope.response=data,data.success===!0){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/schema/preview.html",controller:"SchemaPreviewCtrl",resolve:{schema:function(){return schema}}});modalInstance.result.then(function(response){},function(){})}}).error(function(data){$scope.response=data})},$http.get(fusio.baseUrl+"backend/schema/"+schema.id).success(function(data){angular.isString(data.source)||(data.source=JSON.stringify(data.source,null,4)),$scope.schema=data})}]).controller("SchemaDeleteCtrl",["$scope","$http","$uibModalInstance","fusio","schema",function($scope,$http,$uibModalInstance,fusio,schema){$scope.schema=schema,$scope["delete"]=function(schema){$http["delete"](fusio.baseUrl+"backend/schema/"+schema.id).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]).controller("SchemaPreviewCtrl",["$scope","$http","$uibModalInstance","schema","fusio",function($scope,$http,$uibModalInstance,schema,fusio){$scope.schema=schema,$scope.response=null,$scope.preview=function(schema){$http.post(fusio.baseUrl+"backend/schema/preview/"+schema.id,null).success(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.preview(schema)}]),angular.module("fusioApp.action",["ngRoute","ui.ace"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/action",{templateUrl:"app/action/index.html",controller:"ActionCtrl"})}]).controller("ActionCtrl",["$scope","$http","$uibModal","$routeParams","$location","fusio",function($scope,$http,$uibModal,$routeParams,$location,fusio){$scope.response=null,$scope.search="",$scope.routes=[],$scope.routeId=$routeParams.routeId?parseInt($routeParams.routeId):null,$scope.load=function(){var search=encodeURIComponent($scope.search),routeId=$scope.routeId;$http.get(fusio.baseUrl+"backend/action?search="+search+"&routeId="+routeId).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.actions=data.entry})},$scope.loadRoutes=function(){$http.get(fusio.baseUrl+"backend/routes").success(function(data){$scope.routes=data.entry})},$scope.changeRoute=function(){$location.search("routeId",$scope.routeId)},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/action?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.actions=data.entry})},$scope.doSearch=function(search){var routeId=$scope.routeId;$http.get(fusio.baseUrl+"backend/action?search="+encodeURIComponent(search)+"&routeId="+routeId).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.actions=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/action/create.html",controller:"ActionCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(action){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/action/update.html",controller:"ActionUpdateCtrl",resolve:{action:function(){return action}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(action){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/action/delete.html",controller:"ActionDeleteCtrl",resolve:{action:function(){return action}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load(),$scope.loadRoutes()}]).controller("ActionCreateCtrl",["$scope","$http","$uibModalInstance","formBuilder","fusio",function($scope,$http,$uibModalInstance,formBuilder,fusio){$scope.action={name:"","class":"",config:{}},$scope.actions=[],$scope.create=function(action){var data=angular.copy(action);if(angular.isObject(data.config)){var config={};for(var key in data.config)data.config.hasOwnProperty(key)&&(config[key]=""+data.config[key]);data.config=config}$http.post(fusio.baseUrl+"backend/action",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$http.get(fusio.baseUrl+"backend/action/list").success(function(data){$scope.actions=data.actions,data.actions[0]&&($scope.action["class"]=data.actions[0]["class"],$scope.loadConfig())}),$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.loadConfig=function(){$scope.action["class"]&&$http.get(fusio.baseUrl+"backend/action/form?class="+encodeURIComponent($scope.action["class"])).success(function(data){var containerEl=angular.element(document.querySelector("#config-form"));containerEl.children().remove();var linkFn=formBuilder.buildHtml(data.element,"action.config");if(angular.isFunction(linkFn)){var el=linkFn($scope);containerEl.append(el)}})}}]).controller("ActionUpdateCtrl",["$scope","$http","$uibModalInstance","$uibModal","action","formBuilder","$timeout","fusio",function($scope,$http,$uibModalInstance,$uibModal,action,formBuilder,$timeout,fusio){$scope.action=action,$scope.actions=[],$scope.update=function(action){var data=angular.copy(action);if(angular.isObject(data.config)){var config={};for(var key in data.config)data.config.hasOwnProperty(key)&&(config[key]=""+data.config[key]);data.config=config}$http.put(fusio.baseUrl+"backend/action/"+action.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.loadConfig=function(){$scope.action["class"]&&$http.get(fusio.baseUrl+"backend/action/form?class="+encodeURIComponent($scope.action["class"])).success(function(data){var containerEl=angular.element(document.querySelector("#config-form"));containerEl.children().remove();var linkFn=formBuilder.buildHtml(data.element,"action.config");if(angular.isFunction(linkFn)){var el=linkFn($scope);containerEl.append(el)}})},$scope.execute=function(action){$http.put(fusio.baseUrl+"backend/action/"+action.id,action).success(function(data){if($scope.response=data,data.success===!0){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/action/execute.html",controller:"ActionExecuteCtrl",resolve:{action:function(){return action}}});modalInstance.result.then(function(response){},function(){})}}).error(function(data){$scope.response=data})},$http.get(fusio.baseUrl+"backend/action/"+action.id).success(function(data){angular.isArray(data.config)&&(data.config={}),$scope.action=data,$scope.loadConfig()})}]).controller("ActionDeleteCtrl",["$scope","$http","$uibModalInstance","action","fusio",function($scope,$http,$uibModalInstance,action,fusio){$scope.action=action,$scope["delete"]=function(action){$http["delete"](fusio.baseUrl+"backend/action/"+action.id).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]).controller("ActionExecuteCtrl",["$scope","$http","$uibModalInstance","action","fusio",function($scope,$http,$uibModalInstance,action,fusio){$scope.action=action,$scope.methods=["GET","POST","PUT","DELETE"],$scope.request={method:"GET",uriFragments:"",parameters:"",body:"{}"},$scope.response=null,$scope.requestOpen=!1,$scope.responseOpen=!0,$scope.execute=function(action,request){var body=JSON.parse(request.body);angular.isObject(body)||(body={});var data={method:request.method,uriFragments:request.uriFragments,parameters:request.parameters,body:body};$http.post(fusio.baseUrl+"backend/action/execute/"+action.id,data).success(function(data){var resp={};data.body?resp=data:(resp.statusCode=500,resp.headers={},resp.body=data),$scope.response={statusCode:resp.statusCode,headers:resp.headers,body:JSON.stringify(resp.body,null,4)}})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.execute(action,$scope.request)}]),angular.module("fusioApp.config",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/config",{templateUrl:"app/config/index.html",controller:"ConfigCtrl"})}]).controller("ConfigCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){$scope.response=null,$scope.search="",$scope.load=function(){var search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/config?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.configs=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/config?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.configs=data.entry})},$scope.doSearch=function(search){$http.get(fusio.baseUrl+"backend/config?search="+encodeURIComponent(search)).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.configs=data.entry})},$scope.openUpdateDialog=function(config){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/config/update.html",controller:"ConfigUpdateCtrl",resolve:{config:function(){return config}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load()}]).controller("ConfigUpdateCtrl",["$scope","$http","$uibModalInstance","config","fusio",function($scope,$http,$uibModalInstance,config,fusio){var data=angular.copy(config);2==data.type?data.value="1"==data.value:3==data.type&&(data.value=parseInt(data.value)),$scope.config=data,$scope.update=function(config){var data=angular.copy(config);2==data.type?data.value=data.value?"1":"0":data.value=""+data.value,$http.put(fusio.baseUrl+"backend/config/"+data.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.connection",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/connection",{templateUrl:"app/connection/index.html",controller:"ConnectionCtrl"})}]).controller("ConnectionCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){$scope.response=null,$scope.search="",$scope.load=function(){var search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/connection?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.connections=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/connection?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.connections=data.entry})},$scope.doSearch=function(search){$http.get(fusio.baseUrl+"backend/connection?search="+encodeURIComponent(search)).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.connections=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/connection/create.html",controller:"ConnectionCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(connection){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/connection/update.html",controller:"ConnectionUpdateCtrl",resolve:{connection:function(){return connection}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(connection){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/connection/delete.html",controller:"ConnectionDeleteCtrl",resolve:{connection:function(){return connection}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load()}]).controller("ConnectionCreateCtrl",["$scope","$http","$uibModalInstance","fusio","formBuilder",function($scope,$http,$uibModalInstance,fusio,formBuilder){$scope.connection={name:"","class":"",config:{}},$scope.connections=[],$scope.create=function(connection){var data=angular.copy(connection);if(angular.isObject(data.config)){var config={};for(var key in data.config)data.config.hasOwnProperty(key)&&(config[key]=""+data.config[key]);data.config=config}$http.post(fusio.baseUrl+"backend/connection",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$http.get(fusio.baseUrl+"backend/connection/list").success(function(data){$scope.connections=data.connections,data.connections[0]&&($scope.connection["class"]=data.connections[0]["class"],$scope.loadConfig())}),$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.loadConfig=function(){$scope.connection["class"]&&$http.get(fusio.baseUrl+"backend/connection/form?class="+encodeURIComponent($scope.connection["class"])).success(function(data){var containerEl=angular.element(document.querySelector("#config-form"));containerEl.children().remove();var linkFn=formBuilder.buildHtml(data.element,"connection.config");if(angular.isFunction(linkFn)){var el=linkFn($scope);containerEl.append(el)}})}}]).controller("ConnectionUpdateCtrl",["$scope","$http","$uibModalInstance","fusio","formBuilder","connection",function($scope,$http,$uibModalInstance,fusio,formBuilder,connection){angular.isArray(connection.config)&&(connection.config={}),$scope.connection=connection,$scope.connections=[],$scope.update=function(connection){var data=angular.copy(connection);if(angular.isObject(data.config)){var config={};for(var key in data.config)data.config.hasOwnProperty(key)&&(config[key]=""+data.config[key]);data.config=config}$http.put(fusio.baseUrl+"backend/connection/"+connection.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.loadConfig=function(){$scope.connection["class"]&&$http.get(fusio.baseUrl+"backend/connection/form?class="+encodeURIComponent($scope.connection["class"])).success(function(data){var containerEl=angular.element(document.querySelector("#config-form"));containerEl.children().remove();var linkFn=formBuilder.buildHtml(data.element,"connection.config");if(angular.isFunction(linkFn)){var el=linkFn($scope);containerEl.append(el)}})},$http.get(fusio.baseUrl+"backend/connection/"+connection.id).success(function(data){$scope.connection=data,$scope.loadConfig()})}]).controller("ConnectionDeleteCtrl",["$scope","$http","$uibModalInstance","fusio","connection",function($scope,$http,$uibModalInstance,fusio,connection){$scope.connection=connection,$scope["delete"]=function(connection){$http["delete"](fusio.baseUrl+"backend/connection/"+connection.id).success(function(data){$scope.response=data,
data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.app",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/app",{templateUrl:"app/app/index.html",controller:"AppCtrl"})}]).controller("AppCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){$scope.response=null,$scope.search="",$scope.load=function(){var search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/app?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.apps=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/app?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.apps=data.entry})},$scope.doSearch=function(search){$http.get(fusio.baseUrl+"backend/app?search="+encodeURIComponent(search)).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.apps=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/app/create.html",controller:"AppCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(app){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/app/update.html",controller:"AppUpdateCtrl",resolve:{app:function(){return app}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(app){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/app/delete.html",controller:"AppDeleteCtrl",resolve:{app:function(){return app}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load()}]).controller("AppCreateCtrl",["$scope","$http","$uibModalInstance","fusio",function($scope,$http,$uibModalInstance,fusio){$scope.app={status:1,name:"",url:"",scopes:[]},$scope.states=[{key:1,value:"Active"},{key:2,value:"Pending"},{key:3,value:"Deactivated"}],$scope.create=function(app){var data=angular.copy(app);angular.isArray(data.scopes)&&(data.scopes=data.scopes.filter(function(val){return null!==val})),$http.post(fusio.baseUrl+"backend/app",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.getUsers=function(name){return $http.get(fusio.baseUrl+"backend/user?search="+encodeURIComponent(name)).then(function(response){return angular.isArray(response.data.entry)?response.data.entry:[]})},$http.get(fusio.baseUrl+"backend/scope?count=1024").success(function(data){$scope.scopes=data.entry})}]).controller("AppUpdateCtrl",["$scope","$http","$uibModalInstance","app","fusio",function($scope,$http,$uibModalInstance,app,fusio){$scope.app=app,$scope.states=[{key:1,value:"Active"},{key:2,value:"Pending"},{key:3,value:"Deactivated"}],$http.get(fusio.baseUrl+"backend/scope?count=1024").success(function(data){$scope.scopes=data.entry,$scope.loadApp()}),$scope.update=function(app){var data=angular.copy(app);data.tokens&&delete data.tokens,angular.isArray(data.scopes)&&(data.scopes=data.scopes.filter(function(val){return null!==val})),$http.put(fusio.baseUrl+"backend/app/"+app.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.loadApp=function(){$http.get(fusio.baseUrl+"backend/app/"+app.id).success(function(data){var scopes=[];if(angular.isArray(data.scopes))for(var i=0;i<$scope.scopes.length;i++){for(var found=null,j=0;j<data.scopes.length;j++)if($scope.scopes[i].name==data.scopes[j]){found=$scope.scopes[i].name;break}scopes.push(found)}data.scopes=scopes,$scope.app=data})},$scope.removeToken=function(token){$http["delete"](fusio.baseUrl+"backend/app/"+app.id+"/token/"+token.id).success(function(data){if($scope.app.tokens){for(var tokens=[],i=0;i<$scope.app.tokens.length;i++)if($scope.app.tokens[i].id!=token.id){tokens.push($scope.app.tokens[i]);break}$scope.app.tokens=tokens}})}}]).controller("AppDeleteCtrl",["$scope","$http","$uibModalInstance","app","fusio",function($scope,$http,$uibModalInstance,app,fusio){$scope.app=app,$scope["delete"]=function(app){$http["delete"](fusio.baseUrl+"backend/app/"+app.id).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.log",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/log",{templateUrl:"app/log/index.html",controller:"LogCtrl"})}]).controller("LogCtrl",["$scope","$http","$uibModal","$timeout","fusio",function($scope,$http,$uibModal,$timeout,fusio){var from=new Date;from.setMonth(from.getMonth()-1);var to=new Date;$scope.search="",$scope.filter={from:from,to:to},$scope.routes=[],$scope.apps=[],$scope.load=function(){var search="";$scope.search&&(search=encodeURIComponent($scope.search)),$http.get(fusio.baseUrl+"backend/log?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.logs=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/log?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.logs=data.entry})},$scope.doFilter=function(){var query="";for(var key in $scope.filter)if($scope.filter[key]){var value;value=$scope.filter[key]instanceof Date?$scope.filter[key].toISOString():$scope.filter[key],query+=key+"="+encodeURIComponent(value)+"&"}$http.get(fusio.baseUrl+"backend/log?"+query).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.logs=data.entry})},$scope.openDetailDialog=function(log){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/log/detail.html",controller:"LogDetailCtrl",resolve:{log:function(){return log}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load(),$timeout(function(){$scope.response=null},2e3)},function(){})},$scope.openFilterDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/statistic/filter.html",controller:"StatisticFilterCtrl",resolve:{filter:function(){return $scope.filter}}});modalInstance.result.then(function(filter){$scope.filter=filter,$scope.doFilter()},function(){})},$scope.load()}]).controller("LogDetailCtrl",["$scope","$http","$uibModal","$uibModalInstance","fusio","log",function($scope,$http,$uibModal,$uibModalInstance,fusio,log){$scope.log=log,$scope.statusLineOpen=!0,$scope.headerOpen=!0,$scope.bodyOpen=!1,$scope.errorsOpen=!1,$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.openTraceDialog=function(error){$uibModal.open({size:"md",backdrop:"static",template:'<div class="modal-body"><pre>'+error.trace+"</pre></div>"})},$http.get(fusio.baseUrl+"backend/log/"+log.id).success(function(data){$scope.log=data})}]),angular.module("fusioApp.rate",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/rate",{templateUrl:"app/rate/index.html",controller:"RateCtrl"})}]).controller("RateCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){$scope.response=null,$scope.search="",$scope.load=function(){var search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/rate?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.rates=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/rate?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.rates=data.entry})},$scope.doSearch=function(search){$http.get(fusio.baseUrl+"backend/rate?search="+encodeURIComponent(search)).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.rates=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/rate/create.html",controller:"RateCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(rate){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/rate/update.html",controller:"RateUpdateCtrl",resolve:{rate:function(){return rate}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(rate){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/rate/delete.html",controller:"RateDeleteCtrl",resolve:{rate:function(){return rate}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load()}]).controller("RateCreateCtrl",["$scope","$http","$uibModalInstance","fusio",function($scope,$http,$uibModalInstance,fusio){$scope.rate={priority:0,name:"",rateLimit:1800,timespan:"",allocation:[{routeId:null,appId:null,authenticated:null,parameters:null}]},$scope.timespan={value:1,unit:"hour"},$scope.intervals=[{key:"minute",value:"minute"},{key:"hour",value:"hour"},{key:"day",value:"day"},{key:"week",value:"week"},{key:"month",value:"month"}],$scope.status=[{key:null,value:"Yes/No"},{key:!0,value:"Yes"},{key:!1,value:"No"}],$scope.routes=[],$scope.apps=[],$scope.create=function(rate){var data=angular.copy(rate);data.timespan=$scope.getTimespan($scope.timespan),data.allocation=$scope.removeNullValuesFromAllocation(rate.allocation),$http.post(fusio.baseUrl+"backend/rate",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.getRoutes=function(){$http.get(fusio.baseUrl+"backend/routes").then(function(response){if(angular.isArray(response.data.entry)){var routes=response.data.entry;routes.unshift({id:null,path:"Every route"}),$scope.routes=routes}})},$scope.getApps=function(){$http.get(fusio.baseUrl+"backend/app").then(function(response){if(angular.isArray(response.data.entry)){var apps=response.data.entry;apps.unshift({id:null,name:"Every app"}),$scope.apps=apps}})},$scope.addAllocation=function(){$scope.rate.allocation.push({routeId:null,appId:null,authenticated:!0,parameters:null})},$scope.removeAllocation=function(index){var allocation=$scope.rate.allocation;allocation.splice(index,1),$scope.rate.allocation=allocation},$scope.removeNullValuesFromAllocation=function(allocation){for(var data=[],i=0;i<allocation.length;i++)data.push($scope.removeNullValuesFromObject(allocation[i]));return data},$scope.removeNullValuesFromObject=function(object){var row={};for(var key in object)object.hasOwnProperty(key)&&null!==object[key]&&(row[key]=object[key]);return row},$scope.getTimespan=function(timespan){return"minute"==timespan.unit?"PT"+timespan.value+"M":"hour"==timespan.unit?"PT"+timespan.value+"H":"day"==timespan.unit?"P"+timespan.value+"D":"week"==timespan.unit?"P"+timespan.value+"W":"month"==timespan.unit?"P"+timespan.value+"M":void 0},$scope.getRoutes()}]).controller("RateUpdateCtrl",["$scope","$http","$uibModalInstance","rate","fusio",function($scope,$http,$uibModalInstance,rate,fusio){$scope.rate=rate,$scope.timespan={value:1,unit:"hour"},$scope.intervals=[{key:"minute",value:"minute"},{key:"hour",value:"hour"},{key:"day",value:"day"},{key:"week",value:"week"},{key:"month",value:"month"}],$scope.status=[{key:null,value:"Yes/No"},{key:!0,value:"Yes"},{key:!1,value:"No"}],$scope.routes=[],$scope.apps=[],$scope.update=function(rate){var data=angular.copy(rate);data.timespan=$scope.getTimespan($scope.timespan),data.allocation=$scope.removeNullValuesFromAllocation(rate.allocation),$http.put(fusio.baseUrl+"backend/rate/"+rate.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$http.get(fusio.baseUrl+"backend/rate/"+rate.id).success(function(data){$scope.parseTimespan(data.timespan),data.allocation=$scope.addNullValuesToAllocation(data.allocation),$scope.rate=data}),$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.getRoutes=function(){$http.get(fusio.baseUrl+"backend/routes").then(function(response){if(angular.isArray(response.data.entry)){var routes=response.data.entry;routes.unshift({id:null,path:"Every route"}),$scope.routes=routes}})},$scope.getApps=function(){$http.get(fusio.baseUrl+"backend/app").then(function(response){if(angular.isArray(response.data.entry)){var apps=response.data.entry;apps.unshift({id:null,name:"Every app"}),$scope.apps=apps}})},$scope.addAllocation=function(){$scope.rate.allocation.push({routeId:null,appId:null,authenticated:!0,parameters:null})},$scope.removeAllocation=function(index){var allocation=$scope.rate.allocation;allocation.splice(index,1),$scope.rate.allocation=allocation},$scope.removeNullValuesFromAllocation=function(allocation){for(var data=[],i=0;i<allocation.length;i++)data.push($scope.removeNullValuesFromObject(allocation[i]));return data},$scope.removeNullValuesFromObject=function(object){var row={};for(var key in object)object.hasOwnProperty(key)&&null!==object[key]&&(row[key]=object[key]);return row},$scope.addNullValuesToAllocation=function(allocation){for(var data=[],i=0;i<allocation.length;i++){var row=allocation[i];row.hasOwnProperty("routeId")||(row.routeId=null),row.hasOwnProperty("appId")||(row.appId=null),row.hasOwnProperty("authenticated")||(row.authenticated=null),row.hasOwnProperty("parameters")||(row.parameters=null),data.push(row)}return data},$scope.getTimespan=function(timespan){return"minute"==timespan.unit?"PT"+timespan.value+"M":"hour"==timespan.unit?"PT"+timespan.value+"H":"day"==timespan.unit?"P"+timespan.value+"D":"week"==timespan.unit?"P"+timespan.value+"W":"month"==timespan.unit?"P"+timespan.value+"M":void 0},$scope.parseTimespan=function(timespan){var value=1,unit="hour";timespan.indexOf("T")!==-1?(timespan.indexOf("H")!==-1?unit="hour":timespan.indexOf("M")!==-1&&(unit="minute"),value=parseInt(timespan.substr(2))):(timespan.indexOf("M")!==-1?unit="month":timespan.indexOf("W")!==-1?unit="week":timespan.indexOf("D")!==-1&&(unit="day"),value=parseInt(timespan.substr(1))),$scope.timespan={value:value,unit:unit}},$scope.getRoutes()}]).controller("RateDeleteCtrl",["$scope","$http","$uibModalInstance","rate","fusio",function($scope,$http,$uibModalInstance,rate,fusio){$scope.rate=rate,$scope["delete"]=function(rate){$http["delete"](fusio.baseUrl+"backend/rate/"+rate.id).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.user",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/user",{templateUrl:"app/user/index.html",controller:"UserCtrl"})}]).controller("UserCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){$scope.response=null,$scope.search="",$scope.load=function(){var search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/user?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.users=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/user?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.users=data.entry})},$scope.doSearch=function(search){$http.get(fusio.baseUrl+"backend/user?search="+encodeURIComponent(search)).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.users=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/user/create.html",controller:"UserCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(user){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/user/update.html",controller:"UserUpdateCtrl",resolve:{user:function(){return user}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(user){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/user/delete.html",controller:"UserDeleteCtrl",resolve:{user:function(){return user}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load()}]).controller("UserCreateCtrl",["$scope","$http","$uibModalInstance","fusio",function($scope,$http,$uibModalInstance,fusio){$scope.user={status:0,name:"",email:"",scopes:[]},$scope.statuuus=[{id:0,name:"Consumer"},{id:1,name:"Administrator"},{id:2,name:"Disabled"}],$scope.scopes=[],$http.get(fusio.baseUrl+"backend/scope?count=1024").success(function(data){$scope.scopes=data.entry}),$scope.create=function(user){var data=angular.copy(user);data.apps&&delete data.apps,data.scopes&&angular.isArray(data.scopes)&&(data.scopes=data.scopes.filter(function(value){return null!==value})),$http.post(fusio.baseUrl+"backend/user",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]).controller("UserUpdateCtrl",["$scope","$http","$uibModalInstance","fusio","user",function($scope,$http,$uibModalInstance,fusio,user){$scope.user=user,$scope.statuuus=[{id:0,name:"Consumer"},{id:1,name:"Administrator"},{id:2,name:"Disabled"}],$scope.scopes=[],$http.get(fusio.baseUrl+"backend/scope?count=1024").success(function(data){$scope.scopes=data.entry,$scope.loadUser()}),$scope.update=function(user){var data=angular.copy(user);data.apps&&delete data.apps,data.scopes&&angular.isArray(data.scopes)&&(data.scopes=data.scopes.filter(function(value){return null!==value})),$http.put(fusio.baseUrl+"backend/user/"+data.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$scope.loadUser=function(){$http.get(fusio.baseUrl+"backend/user/"+user.id).success(function(data){var scopes=[];if(angular.isArray(data.scopes))for(var i=0;i<$scope.scopes.length;i++){for(var found=null,j=0;j<data.scopes.length;j++)if($scope.scopes[i].name==data.scopes[j]){found=$scope.scopes[i].name;break}scopes.push(found)}data.scopes=scopes,$scope.user=data})}}]).controller("UserDeleteCtrl",["$scope","$http","$uibModalInstance","fusio","user",function($scope,$http,$uibModalInstance,fusio,user){$scope.user=user,$scope["delete"]=function(user){$http["delete"](fusio.baseUrl+"backend/user/"+user.id).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.scope",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/scope",{templateUrl:"app/scope/index.html",controller:"ScopeCtrl"})}]).controller("ScopeCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){$scope.response=null,$scope.search="",$scope.load=function(){var search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/scope?search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.scopes=data.entry})},$scope.pageChanged=function(){var startIndex=16*($scope.startIndex-1),search=encodeURIComponent($scope.search);$http.get(fusio.baseUrl+"backend/scope?startIndex="+startIndex+"&search="+search).success(function(data){$scope.totalResults=data.totalResults,$scope.scopes=data.entry})},$scope.doSearch=function(search){$http.get(fusio.baseUrl+"backend/scope?search="+encodeURIComponent(search)).success(function(data){$scope.totalResults=data.totalResults,$scope.startIndex=0,$scope.scopes=data.entry})},$scope.openCreateDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/scope/create.html",controller:"ScopeCreateCtrl"});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openUpdateDialog=function(scope){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/scope/update.html",controller:"ScopeUpdateCtrl",resolve:{scope:function(){return scope}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.openDeleteDialog=function(scope){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/scope/delete.html",controller:"ScopeDeleteCtrl",resolve:{scope:function(){return scope}}});modalInstance.result.then(function(response){$scope.response=response,$scope.load()},function(){})},$scope.closeResponse=function(){$scope.response=null},$scope.load()}]).controller("ScopeCreateCtrl",["$scope","$http","$uibModalInstance","fusio",function($scope,$http,$uibModalInstance,fusio){$scope.scope={name:""},$scope.routes=[],$http.get(fusio.baseUrl+"backend/routes?count=1024").success(function(data){$scope.routes=data.entry}),$scope.create=function(scope){for(var data=angular.copy(scope),routes=[],i=0;i<$scope.routes.length;i++){var methods=[];if($scope.routes[i].allowedMethods)for(var key in $scope.routes[i].allowedMethods)$scope.routes[i].allowedMethods[key]===!0&&methods.push(key.toUpperCase());methods.length>0&&routes.push({routeId:$scope.routes[i].id,allow:!0,methods:methods.join("|")})}data.routes=routes,$http.post(fusio.baseUrl+"backend/scope",data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]).controller("ScopeUpdateCtrl",["$scope","$http","$uibModalInstance","fusio","scope",function($scope,$http,$uibModalInstance,fusio,scope){$scope.scope=scope,$scope.routes=[],$scope.loadRoutes=function(){$http.get(fusio.baseUrl+"backend/routes?count=1024").success(function(data){for(var routes=[],i=0;i<data.entry.length;i++){var route=data.entry[i];if($scope.scope.routes)for(var j=0;j<$scope.scope.routes.length;j++)if($scope.scope.routes[j].routeId==route.id){var methods=[];$scope.scope.routes[j].methods&&(methods=$scope.scope.routes[j].methods.split("|"));for(var allowedMethods={},k=0;k<methods.length;k++)allowedMethods[methods[k].toLowerCase()]=!0;route.allow=!!$scope.scope.routes[j].allow,route.allowedMethods=allowedMethods}routes.push(route)}$scope.routes=routes})},$scope.update=function(scope){var data=angular.copy(scope),routes=[];if($scope.routes)for(var i=0;i<$scope.routes.length;i++){var methods=[];if($scope.routes[i].allowedMethods)for(var key in $scope.routes[i].allowedMethods)$scope.routes[i].allowedMethods[key]===!0&&methods.push(key.toUpperCase());methods.length>0&&routes.push({routeId:$scope.routes[i].id,allow:!0,methods:methods.join("|")})}data.routes=routes,$http.put(fusio.baseUrl+"backend/scope/"+scope.id,data).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null},$http.get(fusio.baseUrl+"backend/scope/"+scope.id).success(function(data){$scope.scope=data,$scope.loadRoutes()})}]).controller("ScopeDeleteCtrl",["$scope","$http","$uibModalInstance","fusio","scope",function($scope,$http,$uibModalInstance,fusio,scope){$scope.scope=scope,$scope["delete"]=function(scope){$http["delete"](fusio.baseUrl+"backend/scope/"+scope.id).success(function(data){$scope.response=data,data.success===!0&&$uibModalInstance.close(data)}).error(function(data){$scope.response=data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]),angular.module("fusioApp.statistic",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/statistic",{templateUrl:"app/statistic/index.html",controller:"StatisticCtrl"})}]).controller("StatisticCtrl",["$scope","$http","$uibModal","$compile","fusio",function($scope,$http,$uibModal,$compile,fusio){var from=new Date;from.setMonth(from.getMonth()-1);var to=new Date;$scope.filter={from:from,to:to},$scope.chart={},$scope.statistic="incoming_requests",$scope.statistics=[{name:"Incoming requests",value:"incoming_requests"},{name:"Most used routes",value:"most_used_routes"},{name:"Most used apps",value:"most_used_apps"},{name:"Errors per route",value:"errors_per_route"}],$scope.doFilter=function(){var statistic=$scope.statistic?$scope.statistic:"incoming_requests",query="";for(var key in $scope.filter)if($scope.filter[key]){var value;value=$scope.filter[key]instanceof Date?$scope.filter[key].toISOString():$scope.filter[key],query+=key+"="+encodeURIComponent(value)+"&"}$http.get(fusio.baseUrl+"backend/statistic/"+statistic+"?"+query).success(function(data){$scope.chart=data})},$scope.getStatisticName=function(statistic){for(var i=0;i<$scope.statistics.length;i++)if($scope.statistics[i].value==statistic)return $scope.statistics[i].name;return null},$scope.openFilterDialog=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/statistic/filter.html",controller:"StatisticFilterCtrl",resolve:{filter:function(){return $scope.filter}}});modalInstance.result.then(function(filter){$scope.filter=filter,$scope.doFilter()},function(){})},$scope.doFilter()}]).controller("StatisticFilterCtrl",["$scope","$http","$uibModalInstance","fusio","filter",function($scope,$http,$uibModalInstance,fusio,filter){$scope.filter=filter,$scope.doFilter=function(){$uibModalInstance.close($scope.filter)},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$http.get(fusio.baseUrl+"backend/routes").success(function(data){$scope.routes=data.entry}),$http.get(fusio.baseUrl+"backend/app").success(function(data){$scope.apps=data.entry})}]),angular.module("fusioApp.import",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/import",{templateUrl:"app/import/index.html",controller:"ImportCtrl"})}]).controller("ImportCtrl",["$scope","$http","$uibModal","fusio",function($scope,$http,$uibModal,fusio){$scope.source=null,$scope.error=null,$scope.success=!1,$scope.transform=function(source,format){$http.post(fusio.baseUrl+"backend/import/"+format,{schema:source}).success(function(data){return"success"in data&&data.success===!1?void($scope.error=data.message):($scope.error=null,void $scope.openPreviewDialog(data))}).error(function(data){"success"in data&&data.success===!1?$scope.error=data.message:$scope.error="An unknown error occured"})},$scope.openPreviewDialog=function(data){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/import/preview.html",controller:"ImportPreviewCtrl",resolve:{data:function(){return data}}});modalInstance.result.then(function(response){$scope.success=!0},function(){})}}]).controller("ImportPreviewCtrl",["$scope","$http","$uibModalInstance","$uibModal","fusio","data",function($scope,$http,$uibModalInstance,$uibModal,fusio,data){$scope.data=data,$scope.doProcess=function(){$http.post(fusio.baseUrl+"backend/import/process",data).success(function(data){return"success"in data&&data.success===!1?void($scope.error=data.message):($scope.error=null,void $uibModalInstance.close())}).error(function(data){"success"in data&&data.success===!1?$scope.error=data.message:$scope.error="An unknown error occured"})},$scope.openRouteDialog=function(route){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/import/route.html",controller:"ImportRouteCtrl",resolve:{route:function(){return route}}});modalInstance.result.then(function(response){},function(){})},$scope.openActionDialog=function(action){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/import/action.html",controller:"ImportActionCtrl",resolve:{action:function(){return action}}});modalInstance.result.then(function(response){},function(){})},$scope.openSchemaDialog=function(schema){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:"app/import/schema.html",controller:"ImportSchemaCtrl",resolve:{schema:function(){return schema}}});modalInstance.result.then(function(response){},function(){})},$scope.close=function(){$uibModalInstance.dismiss("cancel")}}]).controller("ImportRouteCtrl",["$scope","$http","$uibModalInstance","fusio","route",function($scope,$http,$uibModalInstance,fusio,route){$scope.route=route,$scope.statuuus=[{key:4,value:"Development"},{key:1,value:"Production"},{key:2,value:"Deprecated"},{key:3,value:"Closed"}],$scope.close=function(){$uibModalInstance.dismiss("cancel")}}]).controller("ImportActionCtrl",["$scope","$http","$uibModalInstance","action",function($scope,$http,$uibModalInstance,action){$scope.action=angular.copy(action),$scope.close=function(){action.name=$scope.action.name,angular.isObject($scope.action.config)&&(action.config=$scope.action.config),$uibModalInstance.dismiss("cancel")}}]).controller("ImportSchemaCtrl",["$scope","$http","$uibModalInstance","schema",function($scope,$http,$uibModalInstance,schema){var copySchema=angular.copy(schema);angular.isObject(copySchema.source)&&(copySchema.source=JSON.stringify(copySchema.source,null,4)),$scope.schema=copySchema,$scope.close=function(){schema.name=$scope.schema.name,angular.isString($scope.schema.source)&&(schema.source=JSON.parse($scope.schema.source)),$uibModalInstance.dismiss("cancel")}}]),fusioApp.factory("formBuilder",["$sce","$compile",function($sce,$compile){var builder={};return builder.buildHtml=function(elements,propertyName){if(!elements||!angular.isArray(elements)||0===elements.length)return null;for(var form="<div>",i=0;i<elements.length;i++){var el=elements[i];if(el.name&&el.title){var helpId;if(el.help&&(helpId="help-"+el.name),form+='<div class="form-group">',"http://fusio-project.org/ns/2015/form/textarea"==el.element)form+='<label for="config-'+el.name+'">'+el.title+":</label>",
form+="<div ui-ace=\"{mode: '"+el.mode+'\'}" ng-model="'+propertyName+"."+el.name+'" id="config-'+el.name+'" aria-describedby="'+helpId+'"></div>';else if("http://fusio-project.org/ns/2015/form/input"==el.element)form+='<label for="config-'+el.name+'">'+el.title+":</label>",form+='<input type="'+el.type+'" name="config-'+el.name+'" id="config-'+el.name+'" ng-model="'+propertyName+"."+el.name+'" value="'+(el.value?el.value:"")+'" aria-describedby="'+helpId+'" class="form-control" />';else if("http://fusio-project.org/ns/2015/form/select"==el.element){form+='<label for="config-'+el.name+'">'+el.title+":</label>",form+='<select name="config-'+el.name+'" id="config-'+el.name+'" ng-model="'+propertyName+"."+el.name+'" aria-describedby="'+helpId+'" class="form-control">';var options=el.options;if(angular.isArray(options))for(var j=0;j<options.length;j++)form+='<option value="'+options[j].key+'">'+options[j].value+"</option>";form+="</select>"}else form+='<label for="config-'+el.name+'">'+el.title+":</label>",form+='<input type="text" name="config-'+el.name+'" id="config-'+el.name+'" ng-model="'+propertyName+"."+el.name+'" value="'+(el.value?el.value:"")+'" aria-describedby="'+helpId+'" class="form-control" />';el.help&&(form+='<span class="help-block" id="'+helpId+'">'+el.help+"</span>"),form+="</div>"}}return form+="</div>",$compile(form)},builder}]),fusioApp.factory("helpLoader",["$http","$showdown","$q","$uibModal",function($http,$showdown,$q,$uibModal){var helper={};return helper.load=function(path){return $q(function(resolve,reject){$http.get(path).success(function(data,status){var parser=document.createElement("a");if(parser.href=path,parser.hash){var heading=parser.hash.substr(1);if(""!==heading){var regexp=new RegExp("(^###\\s"+heading+"$\\s+([\\s\\S]*?))^###\\s","gmi"),matches=regexp.exec(data);data=matches&&matches.length>0?matches[1]:"Could not found chapter"}}var html=$showdown.makeHtml(data);html=html.replace(/{{/g,"{<!-- -->{"),html=html.replace(/}}/g,"}<!-- -->}"),resolve(html)}).error(function(data){reject("Could not find help file")})})},helper.showDialog=function(path){this.load(path).then(function(html){$uibModal.open({size:"md",template:'<div class="modal-body">'+html+"</div>"})},function(html){$uibModal.open({size:"md",template:'<div class="modal-body"><div class="alert alert-info">'+html+"</div></div>"})})},helper}]);